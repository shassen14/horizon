services:
  # --- 1. The Backend API ---
  api:
    build: .
    container_name: horizon-api
    restart: always
    command: uvicorn apps.api_server.main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    env_file: .env # Reads your existing .env
    volumes:
      # Mount logs to the Host so they survive container restarts
      # TODO: Consider mounting to NAS path instead
      - ./logs:/app/logs
    depends_on:
      - scheduler

  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: horizon-tunnel
    restart: always
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - api

  # --- 2. The Scheduler (Workers) ---
  scheduler:
    build: .
    container_name: horizon-scheduler
    restart: always
    command: python apps/scheduler/main.py
    env_file: .env
    volumes:
      - ./logs:/app/logs
# Note: DB is external so no db service
